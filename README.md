# TabFlow

A Chrome extension for power users that replaces the browser's native tab switcher with an
intelligent, keyboard-driven HUD backed by a cloud API. Tabs are navigated through a
full-screen overlay inspired by Windows Alt+Tab, with fuzzy search, semantic AI search,
cloud-synced workspaces, and passive browsing analytics.

Built as a full-stack personal project — Chrome extension (Manifest V3) communicating with
a REST API deployed on AWS App Runner, with Neon serverless PostgreSQL, Gemini AI embeddings,
AWS Cognito authentication, and S3 thumbnail storage.

---

## Features

### Tab Management
- Full-screen HUD overlay triggered by Alt+Q, with blur backdrop and smooth entrance animation
- Most Recently Used (MRU) ordering — tabs are sorted by last-accessed time
- Fuzzy search across tab titles, URLs, and notes using Fuse.js
- Structured filters: `is:pinned`, `is:audible`, `is:duplicate`, `domain:github.com`
- 2D arrow-key grid navigation with Enter to switch, Backspace to close
- Drag-to-reorder tabs within the grid
- Multi-select with Ctrl+click and Shift+click for bulk operations
- Tab group support — color-coded stripe per group, filter by group name
- Pin, mute, bookmark, and close tabs from keyboard or right-click context menu
- Duplicate tab detection with DUP badge
- Close all tabs from a domain in one action
- Quick-switch between the two most recent tabs (double-tap Alt+Q)

### Search and History
- Fuzzy search with configurable threshold, scoring title and URL
- Semantic AI search via `ai:` prefix — describe a tab in natural language to find it from
  your browsing history, including tabs that are no longer open
- Embeddings generated by Gemini (`text-embedding-004`, 768 dimensions) stored in Neon
  PostgreSQL with pgvector cosine similarity queries

### Workspaces
- Name and save the current set of tabs as a workspace (stored in Neon via REST API)
- One-click restore opens all workspace tabs in a new window
- Workspaces persist across sessions and devices
- Cloud-synced under the authenticated user's account

### Tab Screenshots
- Thumbnails captured automatically on tab activation using `captureVisibleTab`
- Stored in-memory (up to 60 JPEG thumbnails, LRU eviction)
- Screenshots are captured before the HUD opens to prevent capturing the overlay itself
- Fallback display uses the tab's favicon and domain-hashed accent color

### Snooze
- Snooze any tab for 30 minutes, 1 hour, 3 hours, tomorrow, or next week
- Snoozed tabs are removed from the browser and restored at the scheduled time
- Wake scheduling managed by `chrome.alarms` running in the background service worker

### Recently Closed Tabs
- Collapsible section showing the 10 most recently closed tabs
- Restore any closed tab with a single click, backed by `chrome.sessions`

### Notes
- Attach a text note to any tab's URL
- Notes persist in `chrome.storage.local` and sync to cloud when signed in
- Notes display as an overlay on the tab card
- Command palette note editor (`>note` command)

### Command Palette
- Activated by typing `>` in the search bar
- Built-in commands: close duplicates, group/ungroup selected, sort mode, window filter,
  open settings, open cheat sheet

### Analytics
- Passive tracking of time spent per tab and per domain
- Records visit count and total duration to Neon PostgreSQL via REST API
- Inline analytics bar in the HUD header showing top domains from today's session

### Tab Suspender
- Background alarm checks every 5 minutes for tabs inactive beyond a configurable threshold
- Discards (suspends) eligible tabs to free memory
- Skips pinned, active, and audible tabs

### Authentication
- AWS Cognito hosted UI with OAuth 2.0 Authorization Code flow and PKCE
- Token exchange proxied through the Express API to keep the client secret server-side
- On first install, sign-in is prompted automatically
- Falls back to a device UUID for unauthenticated / local development use

---

## Tech Stack

### Extension (`apps/extension/`)

| Technology | Role |
|---|---|
| WXT 0.19 | Chrome extension framework (Manifest V3, HMR dev mode) |
| React 19 | UI component library |
| TypeScript 5.6 | Type safety across all extension code |
| Tailwind CSS 3.4 | Utility-first styling, compiled to shadow DOM |
| Fuse.js 7 | Client-side fuzzy search with configurable scoring |
| Chrome APIs | tabs, tabGroups, sessions, storage, alarms, identity, captureVisibleTab |

### API (`apps/api/`)

| Technology | Role |
|---|---|
| Express.js 5 | HTTP server and routing |
| TypeScript 5.7 | Type safety across all API code |
| Drizzle ORM | Type-safe SQL query builder and schema management |
| postgres.js 3 | PostgreSQL driver (SSL required for Neon) |
| Zod | Request schema validation |
| express-jwt + jwks-rsa | Cognito JWT verification |

### Cloud Infrastructure

| Service | Role |
|---|---|
| Neon (serverless PostgreSQL) | Primary database — workspaces, embeddings, analytics, users |
| pgvector | PostgreSQL extension for 768-dim cosine similarity search |
| AWS Cognito | User authentication, hosted login UI, OAuth 2.0 + PKCE |
| AWS S3 | Tab screenshot storage with presigned URLs |
| AWS App Runner | API deployment (containerized, auto-scaling) |
| Google Gemini API | `text-embedding-004` model — 768-dim tab embeddings |

### Tooling

| Tool | Role |
|---|---|
| pnpm workspaces | Monorepo package management |
| PM2 | API process management in local development |
| Vite 6 | Extension bundler (via WXT) |
| drizzle-kit | Schema migrations and introspection |

---

## Architecture

```
tabflow/
├── apps/
│   ├── extension/                  # Chrome extension (Manifest V3)
│   │   ├── entrypoints/
│   │   │   ├── background/         # Service worker: MRU tracking, message bus,
│   │   │   │                       # thumbnail capture, snooze alarms, analytics
│   │   │   ├── content/            # Content script: mounts HudOverlay via shadow DOM
│   │   │   ├── options/            # Settings page
│   │   │   └── popup/              # Toolbar popup
│   │   ├── components/hud/         # 13 React components (HudOverlay, TabGrid,
│   │   │                           # GridCard, BottomBar, WorkspaceSection, ...)
│   │   └── lib/                    # Hooks, types, fuse-search, frecency,
│   │                               # bookmarks, notes, snooze, api-client, auth
│   └── api/                        # Express.js REST API
│       └── src/
│           ├── db/                 # Drizzle schema (7 tables) + Neon connection
│           ├── routes/             # sync, ai, analytics, thumbnails, auth
│           ├── middleware/         # JWT auth (Cognito), flexible device-ID fallback
│           └── services/           # S3 upload / presigned URL / delete
├── ecosystem.config.cjs            # PM2 process definition
└── package.json                    # Root scripts (dev, build, pm2:start, ...)
```

### Data Flow

```
Chrome browser
  |
  |-- Alt+Q --------> Background service worker
  |                     - Captures tab thumbnail (captureVisibleTab)
  |                     - Toggles HUD via message to content script
  |
  |-- Content script (Shadow DOM)
        |
        |-- HudOverlay (React)
              |-- fetchTabs()   --> background: get-tabs --> MRU list + live Chrome data
              |-- thumbnails    --> background: get-all-thumbnails
              |-- workspaces    --> API: GET /api/sync/workspaces  (Neon)
              |-- ai: query     --> API: GET /api/ai/history       (pgvector)
              |-- analytics     --> API: GET /api/analytics/...    (Neon)
```

---

## Setup

### Prerequisites

- Node.js 18+
- pnpm (`npm install -g pnpm`)
- Chrome or Chromium-based browser
- A Neon PostgreSQL database
- (Optional) AWS account for Cognito, S3, App Runner
- (Optional) Google Cloud project with Generative AI API enabled

### 1. Install dependencies

```bash
pnpm install
```

### 2. Configure the API

Create `apps/api/.env`:

```env
DATABASE_URL=postgresql://user:password@host/dbname?sslmode=require
GEMINI_API_KEY=your_gemini_api_key

# AWS (optional — required for Cognito auth and S3 thumbnails)
AWS_REGION=us-east-2
AWS_ACCESS_KEY_ID=your_key
AWS_SECRET_ACCESS_KEY=your_secret
S3_BUCKET_NAME=your_bucket
COGNITO_USER_POOL_ID=us-east-2_xxxxx
COGNITO_CLIENT_ID=your_client_id
COGNITO_CLIENT_SECRET=your_client_secret
COGNITO_DOMAIN=https://your-domain.auth.us-east-2.amazoncognito.com
```

### 3. Run database migrations

```bash
cd apps/api
pnpm drizzle-kit push
```

### 4. Start the API

```bash
# Development (with hot reload)
pnpm dev:api

# Or with PM2 (persistent, auto-restart)
pnpm pm2:start
```

The API runs on `http://localhost:3001` by default.

### 5. Build and load the extension

```bash
pnpm build
```

In Chrome:
1. Navigate to `chrome://extensions`
2. Enable Developer mode
3. Click "Load unpacked"
4. Select `apps/extension/.output/chrome-mv3`

---

## Usage

| Action | How |
|---|---|
| Open HUD | Alt+Q |
| Close HUD | Esc or click outside |
| Navigate tabs | Arrow keys |
| Switch to tab | Enter |
| Close tab | Backspace or click X on card |
| Search tabs | Type in the bottom search bar |
| Semantic search | Type `ai: describe the tab` |
| Command palette | Type `>` in the search bar |
| Snooze tab | Right-click card, select Snooze |
| Save workspace | Click "+ Save current" in the Workspaces bar |
| Restore workspace | Click the workspace card |
| Multi-select | Ctrl+click or Shift+click cards |
| Quick-switch | Double-tap Alt+Q (toggles last two tabs) |
| Cheat sheet | Press ? while HUD is open |

---

## API Reference

All endpoints require either a Cognito `Authorization: Bearer <token>` header or an
`x-device-id` header (UUID, generated automatically by the extension on first run).

| Method | Path | Description |
|---|---|---|
| GET | `/health` | Health check — returns service status and auth mode |
| POST | `/api/auth/token` | Exchange Cognito authorization code for tokens |
| GET | `/api/sync/workspaces` | List saved workspaces |
| POST | `/api/sync/workspaces` | Save a new workspace |
| DELETE | `/api/sync/workspaces/:id` | Delete a workspace |
| POST | `/api/sync/bookmarks` | Sync a bookmark to cloud |
| POST | `/api/sync/notes` | Sync a note to cloud |
| PUT | `/api/sync/settings` | Sync user settings to cloud |
| POST | `/api/ai/embed` | Generate and store Gemini embedding for a URL |
| GET | `/api/ai/history?q=...` | Semantic search over tab embeddings |
| POST | `/api/analytics/visit` | Record a tab visit with duration |
| GET | `/api/analytics/top-domains` | Top domains by visit count and time |
| POST | `/api/thumbnails/upload` | Get presigned S3 URL for screenshot upload |
| GET | `/api/thumbnails/:tabId` | Get presigned S3 URL for screenshot retrieval |

---

## Development

```bash
# Run API and extension dev server concurrently
pnpm dev:all

# Extension only (hot reload via WXT)
pnpm dev

# API only
pnpm dev:api

# Build extension for production
pnpm build

# Package extension as zip
pnpm zip

# PM2 process management
pnpm pm2:start
pnpm pm2:logs
pnpm pm2:status
pnpm pm2:stop
```
